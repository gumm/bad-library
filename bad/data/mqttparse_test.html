<!DOCTYPE html>
<html>
<head>
    <title>MQTT Parse Unit Tests - bad.ui.Layout</title>
    <script src="../../../closure-library/closure/goog/base.js"></script>
    <script src="../../../deps.js"></script>
    <script type="text/javascript">
        goog.require('bad.MqttParse');
        goog.require('goog.testing.jsunit');
        goog.require('goog.events');
        goog.require('goog.math');
    </script>
</head>
<body>
<script>

var ftc = 1502476730236; // Some time it the future
var ptc = -60 * 60 * 3;  // 3 hours ago.
var tct = ">ticket_id_12345";

/*
 assertTrue([comment,] value)
 assertFalse([comment,] value)
 assertEquals([comment,] expectedValue, observedValue)
 assertNotEquals([comment,] expectedValue, observedValue)
 assertNull([comment,] value)
 assertNotNull([comment,] value)
 assertUndefined([comment,] value)
 assertNotUndefined([comment,] value)
 assertArrayEquals([comment,] expectedValue, observedValue)
 assertSameElements([comment,] expectedValue, observedValue)
 */

var assertBiggerThan = function(comment, a, b) {
    assertTrue(comment, a > b);
};

var assertSmallerThan = function(comment, a, b) {
    assertTrue(comment, a < b);
};

var assertIsArray = function(comment, a) {
    assertEquals(comment, 'array', goog.typeOf(a));
};

var assertIsString = function(comment, a) {
    assertEquals(comment, 'string', goog.typeOf(a));
};

var assertIsNumber = function(comment, a) {
    assertEquals(comment, 'number', goog.typeOf(a));
};

var assertIsInt = function(comment, a) {
    assertFalse(
        'The number should not contain a "."',
        goog.string.contains(a.toString(), '.'),
        a
    );
    assertFalse(
        'The number should not contain a "-"',
        goog.string.contains(a.toString(), '-'),
        a
    );
    assertEquals(comment, 'number', goog.typeOf(a));
};

var assertIsSignedInt = function(comment, a) {
    assertFalse(
        'The number should not contain a "."',
        goog.string.contains(a.toString(), '.'),
        a
    );
    assertEquals(comment, 'number', goog.typeOf(a));
};

var assertIsObject = function(comment, a) {
    assertEquals(comment, 'object', goog.typeOf(a));
};

var assertIsDate = function(comment, a) {
    assertTrue(comment,
    Object.prototype.toString.call(a) === '[object Date]');
};


function setUp() {
    /**
     * Create a new layout
     * @type {bad.MqttParse}
     * @private
     */
    parser = new bad.MqttParse();
}

function tearDown() {
    parser.dispose();
}

function test_parserTests() {
    assertTrue(parser.isEmptyArr([]));
    assertFalse(parser.isEmptyArr(['a']));
    assertFalse(parser.isNotEmptyArr([]));
    assertTrue(parser.isNotEmptyArr(['a']));
}

// Future timestamps should be honoured.
function test_parseFutureTimeStamp() {
    var pl = {"c": [ftc,["func"]]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertIsDate('The reply.ts should be a date', reply.ts);
    assertSmallerThan(
        'The is allowed to be in the future',
        ftc,
        reply.ts.valueOf()
    );
}

// The reply should have a time 3 hours in the past.
function test_parsePastTimeStamp() {
    var pl = {"c": [ptc, ["func"]]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    var now = new Date();
    assertEquals(
        'The reply timestamp should be 3 hours in the past',
        now.getHours() - 3,
        reply.ts.getHours()
    )
}

// A zero timestamp should resolve to now.
function test_parseZeroTimeStamp() {
    var pl = {"c": [0, ["zero"]]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    var now = new Date();
    assertRoughlyEquals(
        'The reply timestamp should be within 10ms from now',
        now.valueOf(),
        reply.ts.valueOf(),
        10
    );
}

function test_parseBrokenTooShort() {
    var pl = {"c": ["func"]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertEquals('Payload too short',
        bad.MqttParse.replyCode.PAYLOAD_TOO_SHORT, reply.code);

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseBrokenTooLong() {
    var pl = {"c": [1,2,3,4]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertEquals('Payload too long of non-X',
        bad.MqttParse.replyCode.PAYLOAD_TOO_LONG, reply.code);

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseBrokenTooLongX() {
    var pl = {"x": [1,2,3,4,5]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertEquals('Payload too long for X',
        bad.MqttParse.replyCode.PAYLOAD_TOO_LONG, reply.code);

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseBrokenWrongType() {
    var pl = {"z": [1,2,3]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertEquals('Payload too short',
        bad.MqttParse.replyCode.TYPE_ERR, reply.code);

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseCommandMin() {
    var pl = {"c": [0, ["func"]]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertNotUndefined('Should have a command key', reply.command);
    assertIsObject('command value should be an object', reply.command);
    assertObjectEquals('Command object should be', {func:[]}, reply.command);
    assertEquals('Code key should be 0', 0, reply.code);
    assertIsDate('The timestamp should be a date', reply.ts);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseCommandMax() {
    var pl = {"c": [0, tct, ["concat", true, false, null, 1, "string"]]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertNotUndefined('Should have a command key', reply.command);
    assertIsObject('command value should be an object', reply.command);
    assertObjectEquals(
            'Command object should be',
            {concat:[ true, false, null, 1, "string"]}, reply.command);

    assertEquals('Code key should be 0', 0, reply.code);
    assertIsDate('The timestamp should be a date', reply.ts);
    assertEquals('The tct key is:', tct, reply.tct);

    assertUndefined('No events', reply.events);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseCommandBrokenNotArray() {
    var pl = {"c": [0,tct,3]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertEquals('Command component must be an array',
        bad.MqttParse.replyCode.COMMAND_NOT_ARRAY, reply.code);

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseCommandBrokenArrEmpty() {
    var pl = {"c": [0, tct, []]};
    var reply = parser.parse(goog.json.serialize(pl));

    assertEquals('Command component may not be empty',
        bad.MqttParse.replyCode.COMMAND_ARR_EMPTY, reply.code);

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseCommandBrokenNotString() {
    var pl = {"c": [1,tct,[1]]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertEquals('Command name must be a string',
        bad.MqttParse.replyCode.COMMAND_STRING, reply.code);

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseEventMin() {
    var pl = {"e": [0, [[100]]]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertNotUndefined('Should have a events key', reply.events);
    assertIsObject('events value should be an object', reply.events);
    assertObjectEquals(
            'events object should be',
            {'100':null}, reply.events);

    assertEquals('Code key should be 0', 0, reply.code);
    assertIsDate('The timestamp should be a date', reply.ts);

    assertUndefined('No command', reply.command);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseEventMax() {
    var pl = {"e": [0, "eventmax",  [
        [100, true],
        [101, false],
        [102, "string"],
        [103, 123.345]
    ]]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertNotUndefined('Should have a events key', reply.events);
    assertIsObject('events value should be an object', reply.events);
    assertObjectEquals(
            'events object should be',
            {
                '100':true,
                '101':false,
                '102':'string',
                '103':123.345
            }, reply.events);

    assertEquals('Code key should be 0', 0, reply.code);
    assertIsDate('The timestamp should be a date', reply.ts);
    assertEquals('The tct key is:', 'eventmax', reply.tct);

    assertUndefined('No command', reply.command);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseEventBrokenNotArray() {
    var pl = {"e": [0, 2]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertEquals('Command name must be a string',
        bad.MqttParse.replyCode.EVENTS_NOT_ARRAY, reply.code);

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseEventBrokenArrayEmpty() {
    var pl = {"e": [0, []]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertEquals('Command name must be a string',
        bad.MqttParse.replyCode.EVENTS_ARR_EMPTY, reply.code);

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseEventBrokenInnerNotArray() {
    var pl = {"e": [0, [1]]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertEquals('Command name must be a string',
        bad.MqttParse.replyCode.EVENT_NOT_ARRAY, reply.code);

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseEventBrokenInnerArrayEmpty() {
    var pl = {"e": [0, [[]]]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertEquals('Command name must be a string',
        bad.MqttParse.replyCode.EVENT_ARR_EMPTY, reply.code);

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseEventBrokenInnerCodeNotNumber() {
    var pl = {"e": [0, [["hello"]]]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertEquals('Command name must be a string',
        bad.MqttParse.replyCode.EVENT_CODE_NOT_NUMBER, reply.code);

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}


function test_parseDataMin() {
    var pl = {"d": [0,[]]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertNotUndefined('Should have a data key', reply.data);
    assertIsArray('data value should be an array', reply.data);
    assertArrayEquals('data array should be', [], reply.data);

    assertEquals('Code key should be 0', 0, reply.code);
    assertIsDate('The timestamp should be a date', reply.ts);

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No iah', reply.iah);
}

function test_parseDataMax() {
    var dataPl = [100, true, false, {"a":"string", "b":123}, null, [1,2,3], "some string"];
    var pl = {"d": [0, "datamax", dataPl]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertNotUndefined('Should have a data key', reply.data);
    assertIsArray('data value should be an array', reply.data);
    assertArrayEquals('data array should be', dataPl, reply.data);

    assertEquals('tct should be:', 'datamax', reply.tct);
    assertEquals('Code key should be 0', 0, reply.code);
    assertIsDate('The timestamp should be a date', reply.ts);

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No iah', reply.iah);
}


function test_parseTransReplyMax() {
    var res = [100, true, false, null, "some string"];
    var pl = {"x": [0, 0, res]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);


    assertArrayEquals('response res should be', res, reply.res);
    assertEquals('Code key should be 0', 0, reply.code);
    assertIsDate('The timestamp should be a date', reply.ts);

    assertUndefined('No tct:', reply.tct);
    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseTransReplyMin() {
    var pl = {"x": [0, 0]};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertEquals('Code key should be 0', 0, reply.code);
    assertIsDate('The timestamp should be a date', reply.ts);

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
    assertUndefined('No iah', reply.iah);
}

function test_parseIamHereMessageZeroTimestamp() {
    var pl = {"i": 0};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertEquals(
        'The reply timestamp be now ',
        Math.floor(new Date().valueOf()/1000),
        Math.floor(reply.ts.valueOf()/1000)
    );

    assertEquals('Code key should be 0', 0, reply.code);
    assertTrue('This is the iah message', reply.iah);
    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
}

function test_parseIamHereMessageNormTimestamp() {
    var now = new Date();
    var pl = {"i": now.valueOf()/1000};
    var reply = parser.parse(goog.json.serialize(pl));
    console.debug(reply);

    assertEquals('Code key should be 0', 0, reply.code);
    assertTrue('This is the iah message', reply.iah);
    assertIsDate('The timestamp should be a date', reply.ts);

    assertEquals(
        'The reply timestamp be exactly the given time ',
        now.valueOf(),
        reply.ts.valueOf()
    );

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
}

function test_parseBrokenIamHereMessage() {
    var pl = {"i": "broken here"};
    var reply = parser.parse(goog.json.serialize(pl));

    assertEquals('Code key should be 0', 1, reply.code);
    assertTrue('This is the iah message', reply.iah);
    assertIsDate('The timestamp should be a date', reply.ts);

    assertEquals(
        'The reply timestamp be exactly the given time ',
        Math.floor(new Date().valueOf()/1000),
        Math.floor(reply.ts.valueOf()/1000)
    );

    assertUndefined('No command', reply.command);
    assertUndefined('No events', reply.events);
    assertUndefined('No tct:', reply.tct);
    assertUndefined('No msg:', reply.msg);
    assertUndefined('No res', reply.res);
    assertUndefined('No data:', reply.data);
}

function test_parseAlarmOnConfirmation() {
    var pl = {"d": [0, [true, "alarm", "on"]]};
    var reply = parser.parse(goog.json.serialize(pl));
    reply.ts = reply.ts.valueOf();
    console.debug(reply)
}

function test_parseAlarmEvent() {
    var pl = {"e": [0,"panel",[[101, "FIRE - MAIN BEDROOM"]]]};
    var reply = parser.parse(goog.json.serialize(pl));
    reply.ts = reply.ts.valueOf();
    console.debug(reply)
}




</script>
</body>
</html>